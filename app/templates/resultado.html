
{% extends "base.html" %}

{% block title %}Resultado da Pesquisa - Preço Ágil{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    
    {% if error %}
    <!-- Erro -->
    <div class="row justify-content-center mt-5">
        <div class="col-lg-8">
            <div class="alert alert-warning text-center py-5">
                <i class="bi bi-exclamation-triangle display-1 mb-3"></i>
                <h3>Nenhum Preço Encontrado</h3>
                <p>Não foi possível encontrar preços para este item.</p>
                <a href="{{ url_for('main.index') }}" class="btn btn-primary mt-3">
                    <i class="bi bi-arrow-left me-2"></i>Nova Busca
                </a>
            </div>
        </div>
    </div>
    
    {% else %}
    
    <!-- Header -->
    <div class="row mt-4 mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-primary">
                    <i class="bi bi-check-circle-fill me-2"></i>Pesquisa Concluída
                </h2>
                <div>
                    {% if pdf_filename %}
                    <a href="{{ url_for('main.download_pdf', filename=pdf_filename) }}" 
                       class="btn btn-success btn-lg me-2">
                        <i class="bi bi-download me-2"></i>Baixar PDF
                    </a>
                    {% endif %}
                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left me-2"></i>Nova Pesquisa
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Info do Item -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Item Pesquisado</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Código:</strong><br>
                            <code class="fs-5">{{ research.item_code }}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Descrição:</strong><br>
                            {{ research.catalog_info.description }}
                        </div>
                        <div class="col-md-3">
                            <strong>Catálogo:</strong><br>
                            <span class="badge bg-info">{{ research.catalog_source }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Estatísticas</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr><td><strong>Mediana:</strong></td><td class="text-end"><strong>R$ {{ "%.2f"|format(stats.median) }}</strong></td></tr>
                        <tr><td>Média:</td><td class="text-end">R$ {{ "%.2f"|format(stats.mean) }}</td></tr>
                        <tr><td>Média Saneada:</td><td class="text-end">R$ {{ "%.2f"|format(stats.sane_mean) }}</td></tr>
                        <tr><td>Coef. Variação:</td><td class="text-end">{{ "%.1f"|format(stats.coefficient_variation * 100) }}%</td></tr>
                        <tr><td>Mínimo:</td><td class="text-end">R$ {{ "%.2f"|format(stats.min) }}</td></tr>
                        <tr><td>Máximo:</td><td class="text-end">R$ {{ "%.2f"|format(stats.max) }}</td></tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-award me-2"></i>Valor Estimado</h5>
                </div>
                <div class="card-body text-center">
                    <h1 class="display-3 text-success">R$ {{ "%.2f"|format(stats.estimated_value) }}</h1>
                    <p class="text-muted">Valor unitário</p>
                    <div class="alert alert-info mt-3">
                        <strong>Método:</strong> {{ stats.recommended_method }}
                    </div>
                    <div class="alert alert-light">
                        <small>{{ stats.justification }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fontes -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-database me-2"></i>Fontes Consultadas</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for source in research.sources_consulted %}
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6>
                                        {% if source.prioridade == 999 %}
                                        <span class="badge bg-warning">TESTE</span>
                                        {% endif %}
                                        {{ source.fonte }}
                                    </h6>
                                    <p class="mb-0"><strong>Preços:</strong> {{ source.quantidade }}</p>
                                    {% if source.nota %}
                                    <small class="text-warning">⚠️ {{ source.nota }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICOS -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>Análise Visual
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#histogram">
                                <i class="bi bi-bar-chart-fill me-1"></i>Histograma
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#boxplot">
                                <i class="bi bi-box me-1"></i>Boxplot
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#timeline">
                                <i class="bi bi-graph-up me-1"></i>Timeline
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#scatter">
                                <i class="bi bi-scatter-chart me-1"></i>Por Fonte
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Conteúdo das tabs -->
                    <div class="tab-content mt-3">
                        <div id="histogram" class="tab-pane fade show active">
                            {{ charts.histogram|safe }}
                        </div>
                        <div id="boxplot" class="tab-pane fade">
                            {{ charts.boxplot|safe }}
                        </div>
                        <div id="timeline" class="tab-pane fade">
                            {{ charts.timeline|safe }}
                        </div>
                        <div id="scatter" class="tab-pane fade">
                            {{ charts.scatter|safe }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preços -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Preços Coletados ({{ research.sample_size }})</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Fonte</th>
                                    <th>Fornecedor</th>
                                    <th>UF</th>
                                    <th>Data</th>
                                    <th class="text-end">Valor (R$)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for price in research.prices_collected[:50] %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><small>{{ price.source }}</small></td>
                                    <td><small>{{ price.supplier[:25] }}</small></td>
                                    <td>{{ price.region }}</td>
                                    <td><small>{{ price.date[:10] if price.date is string else price.date.strftime('%d/%m/%Y') }}</small></td>
                                    <td class="text-end"><strong>{{ "%.2f"|format(price.price) }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if research.prices_collected|length > 50 %}
                        <p class="text-center text-muted">Mostrando 50 de {{ research.prices_collected|length }}. Veja todos no PDF.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações -->
    <div class="row mb-5">
        <div class="col text-center">
            {% if pdf_filename %}
            <a href="{{ url_for('main.download_pdf', filename=pdf_filename) }}" 
               class="btn btn-success btn-lg me-2">
                <i class="bi bi-download me-2"></i>Baixar Relatório PDF
            </a>
            {% endif %}
            <a href="{{ url_for('main.historico') }}" class="btn btn-outline-secondary btn-lg me-2">
                <i class="bi bi-clock-history me-2"></i>Ver Histórico
            </a>
            <a href="{{ url_for('main.index') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-search me-2"></i>Nova Pesquisa
            </a>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}
